<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>InfList</title>
        <!----- jquery ----->
        <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
        <!-- bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
        <!-- animate.css -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
        <!-- font -->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300&display=swap" rel="stylesheet">
        <!-- Black Hans Sans-->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300&display=swap" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
        
        <style>
            header {
                width: 60vw;
                height: 5vh;
                margin-bottom: 3vh;
            }

            body {
                width: 100vw;
                margin-top: 3vh;

                color : black;
                font-family: 'Noto Sans KR', sans-serif;

            }

            a:link { color:black; text-decoration: none;}
            a:visited { color: black; text-decoration: none;}
            a:hover { color:black; text-decoration: none;}

            .row_top {
                width: 100%;
                margin-left: 20vw;
            }

            .row_content_box {
                margin-left: 10vw;
                height: 70vh;
            }

            .row_content {
                height: 15vh;
                margin-left: 5vw;
            }

            .container_search {
                padding: 0 auto;
                vertical-align: middle;
                white-space: nowrap;
            }

            .search_bar {
                background-color: white;
                border: 3px solid #596fff;
                border-right: none;
                padding: 1vh 0;
                border-radius: 5px 0 0 5px;
                outline: none;
                width: 40vw;
            }

            .row_description {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                width: 100%;
                height: 100%;
                display:block;
                font-size: 14px;
            }

            .lens {
                width: 2vw;
                height: 5.9vh;
                border: 1px solid #596fff;
                background-color: #596fff;
                text-align: center;
                color: #fff;
                border-radius: 0 5px 5px 0;
                cursor: pointer;
            }

            .box {
                width: 5vw;
                height: 5vw;
                border-radius: 70%;
                overflow: hidden;
            }

            .icon {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            #sec_result {
                margin-left: 10vw;
                width: 80vw;
                height: 75vh;
            }
        </style>

        <script>
            var kw;
            $(document).ready(function() {
                function getKeywordInfo() {
                    var maskHeight = $(document).height();
                    var maskWidth  = window.document.body.clientWidth;

                    var mask       ="<div id='mask' style='position:absolute; z-index:9000; background-color:#000000; display:none; left:0; top:0;'></div>";
                    var loadingImg ='';
                    var gif = "img/searching.gif";
                
                    loadingImg +=" <img src='"+ gif +"' style='position: absolute; display: block; margin: 0px auto;'/>";
            
                    $('body').append(mask)
                    $('#mask').css({
                        'width' : maskWidth,
                        'height': maskHeight,
                        'opacity' :'0.3'
                    });
                    $('#mask').show();
                    $('#loading_img').append(loadingImg);
                    $('#loading_img').show();

                    setTimeout(function() {
                        $('#mask, #loading_img', '#div_output').hide();
                        $('#mask, #loading_img', '#div_output').empty(); 
                    }, 1000);

                    kw = $("#input_search").val();
                    $("#div_output").empty();
                    if (!kw) {
                        alert('키워드를 입력해주세요.');
                    } else {
                        var is_loaded = false;
                        $.ajax({
                            url: "/keyword",
                            async: true,
                            type: "POST",
                            data: {
                                keyword: kw
                            },
                            dataType: "JSON",
                            success : function(jsonData) {
                                $(jsonData).each(function (index, item) {
                                    var output = '';
                                    output += '<div class="row row_content">'
                                    $('#output').append(output);
                                    $.ajax({
                                        type : "GET",
                                        dataType : "JSON",
                                        url : `https://www.googleapis.com/youtube/v3/channels?id=${item.yt_url.substring(9)}&part=snippet&key=AIzaSyDmrf3DxFShAiFtvapwqOtn_HMBgciQqqk`,
                                        async: false,
                                        contentType : "application/json",
                                        success : function(jd) {
                                            is_loaded = true;
                                            var items = jd.items[0];
                                            output += ` <div class="col-md-1" style="height:100%; padding: 4vh 0px; text-align:center; font-size: 32px;">\
                                                            <b>${index+1}</b>\
                                                        </div>
                                                        <div class="col-md-6" style="height:100%; padding: 2.5vh 0px;">\
                                                            <div class="row"\>
                                                                <div class="col-md-3">\
                                                                    <div class="box">\
                                                                        <div class="row">\
                                                                            <a href="https://www.youtube.com/channel/${item.yt_url.substring(9)}" target="_blank">\
                                                                                <img class="icon" src="${items.snippet.thumbnails.medium.url}" />\
                                                                            </a>\
                                                                        </div>\
                                                                    </div>\
                                                                </div>\
                                                                <div class="col-md-9">\
                                                                    <a href="https://www.youtube.com/channel/${item.yt_url.substring(9)}" target="_blank">\
                                                                        <div class="row" style="font-size: 18px;">\
                                                                            <b>${item.yt_name}</b>\
                                                                        </div>\
                                                                        <div class="row row_description">\
                                                                            ${items.snippet.description}
                                                                        </div>\
                                                                    </a>\
                                                                </div>\
                                                            </div>\
                                                        </div>\
                                                    `
                                            $.ajax({
                                                type : "GET",
                                                dataType : "JSON",
                                                url : `https://www.googleapis.com/youtube/v3/channels?id=${item.yt_url.substring(9)}&part=statistics&key=AIzaSyDmrf3DxFShAiFtvapwqOtn_HMBgciQqqk`,
                                                async: false,
                                                contentType : "application/json",
                                                success : function(jsd) {
                                                    var it = jsd.items[0].statistics;
                                                    output += `  <div class="col-md-5" style="padding: 3vh 0;">\
                                                                    <div class="row">\
                                                                        <div class="col-md-3">\
                                                                            <b>구독자수</b>\
                                                                        </div>\
                                                                        <div class="col-md-4">\
                                                                            <h6 style="text-align:right; margin: 0 auto; ">${it.subscriberCount}</h6>\
                                                                        </div>\
                                                                    </div>\
                                                                    <div class="row">\
                                                                        <div class="col-md-3">\
                                                                            <b>총조회수</b>\
                                                                        </div>\
                                                                        <div class="col-md-4">\
                                                                            <h6 style="text-align:right; margin: 0 auto; ">${it.viewCount}</h6>\
                                                                        </div>\
                                                                    </div>\
                                                                    <div class="row">\
                                                                        <div class="col-md-3">\
                                                                            <b>ER 지수</b>\
                                                                        </div>\
                                                                        <div class="col-md-4">\
                                                                            <h6 style="text-align:right; margin: 0 auto; ">${item.ER_avg}</h6>\
                                                                        </div>\
                                                                    </div>\
                                                                 </div>\
                                                               </div>\
                                                               <hr>`;
                                                    $('#div_output').append(output);
                                                }
                                            })
                                            //$('#div_output').append(output);
                                        },
                                        complete : function(data) {
                                        },
                                        error : function(xhr, status, error) {
                                            console.log("유튜브 요청 에러: "+ error);
                                        }
                                   });
                                })


                            },
                        
                        });

                        if (!is_loaded) {
                            setTimeout(function() {
                                var img_sry = `<div style='text-align:center; margin-top: 10vh'>\
                                                 <img src='img/sorry.png' style='width:10vw; height:10vw;'/>\
                                                 <br>\
                                                 <br>\
                                                 <h2 style="font-family: 'Black Han Sans', sans-serif;"">찾으시는 데이터가 없어요...</h2>\
                                                 <h2 style="font-family: 'Black Han Sans', sans-serif;"">이메일을 알려주시면 결과가 나올때 알려드릴게요</h2>\
                                                 <input id="input_email" style="text-indent: 0.5em; width: 25%; display: inline-block;" class="form-control" type="text" placeholder="abc@email.com" /><button id="btn_submit" style="margin-top:-5px;" type="submit" class="btn btn-primary"><i class="fa fa-paper-plane"></i></button>
                                               </div>`
                                $('#div_output').append(img_sry);
                                $('#div_output').show();
                                $("#btn_submit").on("click", function(){
                                    postKeyword();
                                });
                                /*
                                $("#input_email").on("keyup", function(e) {
                                    if (e.keyCode == 13) postKeyword();
                                })
                                */
                            }, 1000);
                        }
                    }
                }
                // event binding
                $("#logo").on("click", function() {
                    location.href="/"; 
                })
                $("#btn_search").on("click", function(){
                    getKeywordInfo();
                });
                $("#input_search").on("keyup", function(e) {
                    if (e.keyCode == 13) getKeywordInfo();
                })
            });
            
            function postKeyword() {
                $.ajax({
                    url: "/postKeyword",
                    async: true,
                    type: "POST",
                    data: {
                        keyword: kw
                    },
                    dataType: "JSON",
                    success : function(jsonData) {
                    },
                });
            }
        </script>
    </head>
    <body id="body">
        <header>
            <div class="row row_top">
                <div class="col-md-4">
                    <img id="logo" style="height: 5vh; margin: 0 auto; cursor:pointer;" src="img/logo_main.png">
                </div>
                <div class="col-md-8 text-right container_search">
                    <input id="input_search" style="text-indent: 0.5em; width: 80%; display: inline-block;" class="form-control" type="text" placeholder="키워드로 검색 가능합니다." /><button id="btn_search" style="margin-top:-5px;" type="submit" class="btn btn-primary"><i class="fa fa-search"></i></button>
                </div>
            </div>
        </header>
        <hr style="background-color: black !important; height:0.1vh;">
        <section id="sec_result">
            <div id="loading_img" style="position:absolute; margin-left: 35vw;">

            </div>
            <div id="div_output" class="row row_content_box" style="width:60vw;">
            </div>
        </section>
    </body>
</html>